package aoc
package y2025

import scala.annotation.tailrec

object Day7:
  def solve(input: String): Int =
    val grid = input.linesIterator.toVector

    @tailrec def loop(beams: Set[Coord], count: Int = 0): Int =
      val (newBeams, splits) = beams.foldLeft(Set.empty[Coord] -> count):
        case ((acc, count), beam) =>
          val nextCoord = beam + Direction.Up.direction
          grid.get(nextCoord) match
            case Some('^') =>
              (
                acc ++ Set(Direction.Left, Direction.Right).map(nextCoord + _.direction),
                count + 1
              )
            case Some(_) => (acc + nextCoord, count)
            case None    => (acc, count)

      if newBeams.isEmpty then splits else loop(newBeams, splits)

    loop(Set(Coord(grid.head.indexOf('S'), 0)))

  def solve2(input: String): Long =
    val grid = input.linesIterator.toVector

    def loop(beam: Coord, acc: Map[Coord, Long] = Map.empty): Map[Coord, Long] =
      if acc.contains(beam) then acc
      else
        val nextCoord = beam + Direction.Up.direction
        grid.get(nextCoord) match
          case Some('^') =>
            Set(Direction.Left, Direction.Right).foldLeft(acc): (acc, d) =>
              val lrCoord = nextCoord + d.direction
              val map     = loop(lrCoord, acc)
              (acc ++ map).updatedWith(beam):
                case Some(v) => Some(v + map(lrCoord))
                case None    => Some(map(lrCoord))
          case Some(_) =>
            val map = loop(nextCoord, acc)
            map.updated(beam, map(nextCoord))
          case None => Map(beam -> 1L)

    val root = Coord(grid.head.indexOf('S'), 0)
    loop(root)(root)

  val input =
    """......................................................................S......................................................................
      |.............................................................................................................................................
      |......................................................................^......................................................................
      |.............................................................................................................................................
      |.....................................................................^.^.....................................................................
      |.............................................................................................................................................
      |....................................................................^...^....................................................................
      |.............................................................................................................................................
      |...................................................................^.....^...................................................................
      |.............................................................................................................................................
      |..................................................................^...^...^..................................................................
      |.............................................................................................................................................
      |.................................................................^.^...^.^.^.................................................................
      |.............................................................................................................................................
      |................................................................^.^.......^.^................................................................
      |.............................................................................................................................................
      |...............................................................^...^...^.^.^.^...............................................................
      |.............................................................................................................................................
      |..............................................................^.^.^...^.......^..............................................................
      |.............................................................................................................................................
      |.............................................................^...^.^.^.^...^.^.^.............................................................
      |.............................................................................................................................................
      |............................................................^.^.^.^...^.......^.^............................................................
      |.............................................................................................................................................
      |...........................................................^.^.^.^.^.^.^.^.^...^.^...........................................................
      |.............................................................................................................................................
      |..........................................................^.....^.^.^.^.^.....^...^..........................................................
      |.............................................................................................................................................
      |.........................................................^.^.....^.^.^.^.^...^.^.^.^.........................................................
      |.............................................................................................................................................
      |........................................................^.^.^.^.^.^.^.^...^...^.....^........................................................
      |.............................................................................................................................................
      |.......................................................^.^.^.^.^.^.^.......^...^.....^.......................................................
      |.............................................................................................................................................
      |......................................................^.^.^.^...^.^.....^.^.^.^.^...^.^......................................................
      |.............................................................................................................................................
      |.....................................................^.^.^.^.^.^.^.....^.....^...^.^.^.^.....................................................
      |.............................................................................................................................................
      |....................................................^.^...^.^.......^.^.^.......^...^.^.^....................................................
      |.............................................................................................................................................
      |...................................................^...^.^...^...^.^.^.^.^...^...^.^.....^...................................................
      |.............................................................................................................................................
      |..................................................^.....^...^.^.^.....^...^.^...^.......^.^..................................................
      |.............................................................................................................................................
      |.................................................^.^.^.^.^.^.^.^...^.^.^.^.^.....^.^...^.^.^.................................................
      |.............................................................................................................................................
      |................................................^.^...^.^.....^.^.....^...^.^.^.....^.^...^.^................................................
      |.............................................................................................................................................
      |...............................................^.........^.^.^.^.^.^.^.^...^.^.^.^...........^...............................................
      |.............................................................................................................................................
      |..............................................^.^.......^...^...^...^...^.^.^.^.^.^.^.^.^.^.^.^..............................................
      |.............................................................................................................................................
      |.............................................^.........^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.............................................
      |.............................................................................................................................................
      |............................................^.^...^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^............................................
      |.............................................................................................................................................
      |...........................................^.^.^.^...^.^.^.^.^.^.....^.^.^.^.^.^.^...^.^.^.^.^...^...........................................
      |.............................................................................................................................................
      |..........................................^.....^.^.......^.^.^.^.^.^.^.....^.^.^.^.....^.^.^.^.^.^..........................................
      |.............................................................................................................................................
      |.........................................^.....^.^.^.^.^.^.^...^.^.^.....^.....^.^.....^.^.......^.^.........................................
      |.............................................................................................................................................
      |........................................^.^...^.^.^.^...^...^.^.^.^.^...^.^.^.^...^.....^.^.^...^...^........................................
      |.............................................................................................................................................
      |.......................................^.^.^.^.^.......^...^.^.^.^...^...^.^.^...^...^.^.^...........^.......................................
      |.............................................................................................................................................
      |......................................^.^...^.^.^.^...^...^.^.^.........^.^.^.^...^.^.^.^...^...^.....^......................................
      |.............................................................................................................................................
      |.....................................^.........^.^.^.^.^.^...^.........^.^.^.^.^.^.^.^.^...^.^.^...^...^.....................................
      |.............................................................................................................................................
      |....................................^.^.^...^.^.^.....^.^.^.^.^.....^.^.^...^...^...^.^.^.^...^...^...^.^....................................
      |.............................................................................................................................................
      |...................................^...^.^.^.^.^...^...^...^...^.^.^.^.^...^.^.^...^...^.^.^.........^.^.^...................................
      |.............................................................................................................................................
      |..................................^.^.^.^...^.^.....^.^.^.^.^...^...^.^.^.^.....^...^...^.^...^.^...^.^...^..................................
      |.............................................................................................................................................
      |.................................^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.......^...^.^.^.......^...^.^.^.^.^.^.^.^.................................
      |.............................................................................................................................................
      |................................^.^.^...^.^...^.^...^.^.^.^...^.^...^.^.^.^.....^.....^.^.^.^.^.......^...^.^................................
      |.............................................................................................................................................
      |...............................^.^.^...^.^.^...^.^.^.^.^.^.....^.^.^.^...^.^.^.^.^.^.^.....^.^.^.^.....^.....^...............................
      |.............................................................................................................................................
      |..............................^.^...^.^.^.^.^.^...^.^.^.^...^.^.^...^.^...^.^...^.^.^.^...^.^.....^.^.^.....^.^..............................
      |.............................................................................................................................................
      |.............................^.^.^.^.^...^.^.^.^.^...^...^.^.^.^.^.........^.^.^...^.^...^.^...^.^.^...^...^.^.^.............................
      |.............................................................................................................................................
      |............................^...^.^...^.^...^.^.^.^...^.^.^.^.^...^.^.......^.^.^.^...^.^...^.^.^...^.^.........^............................
      |.............................................................................................................................................
      |...........................^.^.^...^.^.^.^...^.^.^.....^.^.^.^.......^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^...........................
      |.............................................................................................................................................
      |..........................^.^...^...^.^.^...^.^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.^.^...^...^.^.^.^...^.^.^.^.^...^.^..........................
      |.............................................................................................................................................
      |.........................^.^.^...^.^.^...^.^.^.^.....^.^...^...^.^...^.^.....^...^.^.^.^.^.^.^.....^.^.^.......^...^.........................
      |.............................................................................................................................................
      |........................^...^.^.^.^.^.^...^.^...^.^...^.^.........^.^.....^.^.^...........^...^.^.^.^...^.^.^.^.^.^.^........................
      |.............................................................................................................................................
      |.......................^.^.^.....^.^.^.....^.^.^.^.^.^...^.^.^...^.^.^.^.^...^.....^.^...^.^.^...^.^.^.^...^.^.^.^.^.^.......................
      |.............................................................................................................................................
      |......................^.^.^.^.^.^...^...^.^.......^...^.^...^.^...^.^.^.^.^.^.^...^.....^...^...^...^.^...^.^...^.^.^.^......................
      |.............................................................................................................................................
      |.....................^.^...^.^.^.^.^...^.^.^...^.^.^.^...^...^.^.^...^.....^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^...^.^.^.....................
      |.............................................................................................................................................
      |....................^...^.^.^.^.^.....^.^.^.......^.^.^.^.^.^.^.^.......^...^...^.^.....^.....^...^.^...^.^.^.^.^.^.^...^....................
      |.............................................................................................................................................
      |...................^.^...^.^.^.^.^.^.^.^.............^.........^.^.^...^...^...^.^.........^.^.....^.^...^.....^.^.^.^...^...................
      |.............................................................................................................................................
      |..................^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.....^...^.^.^.^.........^.^...^...^.^.......^.....^.^.^.....^.^...^..................
      |.............................................................................................................................................
      |.................^.^.^...^...^.^.^.^.^.^.^.^.^.^...^...^.^...^.^.^.^...^.^.^.^.^.^.^...^.^.......^.^...^.^.........^...^.^.^.................
      |.............................................................................................................................................
      |................^.^.^.....^...^.^...^.^.^.^.^.^...^.^...^.^.^.^.^.^.....^.^.^.^.^.....^...^.....^.^.^.....^.^.^.^.^...^.^...^................
      |.............................................................................................................................................
      |...............^.^.....^.^...^...^...^.^.^.......^...^.^...^.^.^...^.^.^.......^.^...^.^.^...^...^.^.....^...^...^.^.....^...^...............
      |.............................................................................................................................................
      |..............^.^.^.....^.^.^.^.^...^...^.^...^...^.^.^.....^...^.^.^.^.^...^.^.^.^.......^.^.....^...^.^...^.^.^...^.^.^...^.^..............
      |.............................................................................................................................................
      |.............^.^.^.^.^.....^.^...^.^...^...^.^.^...^.^.^...^...^.^.^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.^...^...^.^.^.^...^.....^.^.............
      |.............................................................................................................................................
      |............^.^.^...^.......^.^...^.^.^.......^.^...^.^.^...^.^.^...........^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.......^.^.^.^.^.^.^.^............
      |.............................................................................................................................................
      |...........^.....^.^...^...^.^...^...^...^.^.^...^...^...^.^.^...^.....^...^...^...^.....^...^.....^.^.^...^.^.^...^.^...^.^.^.^.^...........
      |.............................................................................................................................................
      |..........^.^.^.^.^.......^.^.^.^.^.^.....^.....^.^...^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^...^.^.....^...^.^.^..........
      |.............................................................................................................................................
      |.........^...^.^.^...^.^.^.^.^.....^...^...^.^.^...^.^.^...^...^.^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.....^.^.^.......^.^.^.^.........
      |.............................................................................................................................................
      |........^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.......^.^.^.^.^.^.^...^.^.^.....^...^.^.....^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^........
      |.............................................................................................................................................
      |.......^.^.......^.^.^.^.^.^.^...^.^.^.^.......^.....^...^.^.^.^.^.^.^.^...^.^...^...^.^.....^.^.....^...^.^.......^...^.^.^.^.^.^...^.......
      |.............................................................................................................................................
      |......^.^...^...^.^.^...^...^.^.^.^.^.^...^.^...^.....^.^.^.^.......^...^...^.^.....^.^.^.....^.^...^.^.....^.^.^.^.^.....^.....^.....^......
      |.............................................................................................................................................
      |.....^.^.^.^.....^.^.^.^.^.^.^...^.^.....^.^.^.....^.^.........^.^...^.^.....^...^.^.^.^.^.......^.^.....^.....^.^.^.^.^.^.^.....^.^...^.....
      |.............................................................................................................................................
      |....^...^.....^.^...^...^.^.^.........^.^.^.^.^.^.^.^.^.^.^.^...^.^.....^.....^.^.^.....^.^.^.^.^.^.....^.^.^.^.^...^.^.^.^...^.^.^.^...^....
      |.............................................................................................................................................
      |...^.....^.^.^.^...^.^.^.^.^.^.^...^.^.......^.^...^...^.^...^.^.^.......^.^.^.^.^.^.^.^.^...^.^.^.^...^.^.....^.^.^.^.^...^.^.^...^.^.^.^...
      |.............................................................................................................................................
      |..^.^.^.^...^.^.^.^.^...^.^.^.^.....^.^...^...^.^.^.^.....^.^.^.....^.^...^.^.^...^.^.^.........^.........................^.^.^.^.^.^...^.^..
      |.............................................................................................................................................
      |.^.^.....^.^.^.^.^.^.^...^.^.^...^.^...^.^.^.^...^.....^.^...^.^...^.^.^.^.....^...^.^...^...^.^.^.....^.^...^.^...^...^.^.^.^.^.^.^...^.^.^.
      |.............................................................................................................................................""".stripMargin
