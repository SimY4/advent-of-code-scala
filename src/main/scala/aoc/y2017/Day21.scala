package aoc.y2017

object Day21:
  private val start = Vector(Vector('.', '#', '.'), Vector('.', '.', '#'), Vector('#', '#', '#'))

  private type Image = Vector[Vector[Char]]

  private def parseLine(line: String): Seq[(Image, Image)] =
    line match
      case s"$i => $o" =>
        val in  = i.split("/").map(_.toVector).toVector
        val out = o.split("/").map(_.toVector).toVector
        Seq(
          in,
          in.reverse,
          in.map(_.reverse),
          in.reverse.map(_.reverse),
          in.transpose,
          in.transpose.map(_.reverse),
          in.transpose.reverse,
          in.transpose.reverse.map(_.reverse)
        ).map(_ -> out)

  private def process(image: Image, rules: Map[Image, Image]): Image =
    val size     = image.size
    val step     = if size % 2 == 0 then 2 else 3
    val newSize  = size / step * (step + 1)
    val newImage = Array.fill(newSize)(Array.fill(newSize)('.'))

    for
      i <- image.indices by step
      j <- image.indices by step
      subImage    = image.slice(i, i + step).map(_.slice(j, j + step))
      newSubImage = rules.getOrElse(subImage, subImage)
      x <- newSubImage.indices
      y <- newSubImage.indices
    do newImage(i / step * (step + 1) + x)(j / step * (step + 1) + y) = newSubImage(x)(y)
    newImage.map(_.toVector).toVector

  def solve(input: String, n: Int = 5): Int =
    val rules = input.linesIterator.flatMap(parseLine).toMap
    Iterator.iterate(start)(process(_, rules)).drop(n).next.map(_.count(_ == '#')).sum

  def solve2(input: String): Int = solve(input, 18)

  val input = """../.. => #../.../..#
                |#./.. => ###/##./.#.
                |##/.. => ..#/..#/##.
                |.#/#. => ###/.../#..
                |##/#. => #../#.#/.#.
                |##/## => ##./##./...
                |.../.../... => .##./.##./#.##/#.##
                |#../.../... => #.#./####/..#./#..#
                |.#./.../... => #.../#..#/##.#/#.##
                |##./.../... => .##./##../..##/....
                |#.#/.../... => #.../..##/#.##/#...
                |###/.../... => ##.#/.#../####/....
                |.#./#../... => .###/#..#/####/...#
                |##./#../... => ##.#/#.../..#./####
                |..#/#../... => ####/###./..../#.#.
                |#.#/#../... => ..##/.#../.#.#/...#
                |.##/#../... => #.##/###./####/####
                |###/#../... => #.#./##.#/..#./####
                |.../.#./... => .##./#.../..../#...
                |#../.#./... => ###./.##./...#/....
                |.#./.#./... => .#../..#./###./....
                |##./.#./... => .##./..../.###/...#
                |#.#/.#./... => ###./.##./##.#/#.##
                |###/.#./... => ##../..##/####/...#
                |.#./##./... => ..#./#..#/##../.#..
                |##./##./... => .#../...#/###./##..
                |..#/##./... => .###/.###/####/...#
                |#.#/##./... => ####/#.#./###./##..
                |.##/##./... => ##../..#./###./..#.
                |###/##./... => ##../..../.##./#.#.
                |.../#.#/... => ..#./.#.#/.##./#.##
                |#../#.#/... => ####/..##/#.../#.#.
                |.#./#.#/... => #.../#..#/#.../..##
                |##./#.#/... => .#.#/##.#/.###/#..#
                |#.#/#.#/... => ..#./##.#/##../#..#
                |###/#.#/... => ####/#..#/.##./###.
                |.../###/... => .##./..##/..#./#...
                |#../###/... => .##./###./##../.###
                |.#./###/... => ##../..../..##/##..
                |##./###/... => ##.#/#.#./#.#./##..
                |#.#/###/... => ..##/.#.#/..../.#.#
                |###/###/... => ####/.#../...#/.#..
                |..#/.../#.. => .#.#/#..#/##../##.#
                |#.#/.../#.. => ...#/.#.#/##.#/###.
                |.##/.../#.. => ..##/##../#.../#.##
                |###/.../#.. => ..##/##../#.#./##..
                |.##/#../#.. => #.##/####/##../####
                |###/#../#.. => ##../#..#/#.##/####
                |..#/.#./#.. => #.#./#.##/...#/..#.
                |#.#/.#./#.. => ..../...#/..../#.#.
                |.##/.#./#.. => ...#/#..#/.#../##.#
                |###/.#./#.. => .#../..#./.#../.#..
                |.##/##./#.. => #.##/..../#.##/.#..
                |###/##./#.. => #.../##../#.#./#.##
                |#../..#/#.. => #.../..##/#.#./.#..
                |.#./..#/#.. => ##../#.../#..#/##.#
                |##./..#/#.. => ###./#..#/..##/....
                |#.#/..#/#.. => ...#/##.#/#.../####
                |.##/..#/#.. => .##./###./#.../#..#
                |###/..#/#.. => #.#./.#.#/.#.#/...#
                |#../#.#/#.. => ##.#/####/#.##/##.#
                |.#./#.#/#.. => ...#/.#.#/.#../.##.
                |##./#.#/#.. => ##.#/.##./#.##/####
                |..#/#.#/#.. => ##../.#../##.#/#.#.
                |#.#/#.#/#.. => ..#./###./#..#/.#.#
                |.##/#.#/#.. => ..../.##./..#./##.#
                |###/#.#/#.. => #.#./.#../###./##..
                |#../.##/#.. => ##.#/##.#/.#.#/#.##
                |.#./.##/#.. => ###./.##./..../####
                |##./.##/#.. => ####/#..#/##../###.
                |#.#/.##/#.. => ####/..#./#..#/.#.#
                |.##/.##/#.. => ##../##.#/#.##/.##.
                |###/.##/#.. => ..../..#./####/##.#
                |#../###/#.. => ####/.#.#/#..#/#...
                |.#./###/#.. => #.#./#.#./.#../#...
                |##./###/#.. => ..../#.#./.##./##..
                |..#/###/#.. => ##.#/...#/.#../#.#.
                |#.#/###/#.. => ####/.##./..##/..#.
                |.##/###/#.. => .###/..#./..#./##.#
                |###/###/#.. => ##../..##/.###/.##.
                |.#./#.#/.#. => ...#/##../.#.#/##.#
                |##./#.#/.#. => ##../##../..##/##..
                |#.#/#.#/.#. => .##./###./#.##/.##.
                |###/#.#/.#. => .#.#/.#../.#.#/.##.
                |.#./###/.#. => #.##/####/#..#/....
                |##./###/.#. => #.../#.#./#.../#.##
                |#.#/###/.#. => ###./#.#./##../#...
                |###/###/.#. => ..##/.#.#/###./#..#
                |#.#/..#/##. => #.../#.#./..##/#...
                |###/..#/##. => #.../##.#/#.#./.###
                |.##/#.#/##. => ###./#.../..##/...#
                |###/#.#/##. => ...#/.###/#.##/.#..
                |#.#/.##/##. => .###/..#./#..#/....
                |###/.##/##. => ..../##.#/#..#/##.#
                |.##/###/##. => #.#./..##/.##./##.#
                |###/###/##. => ..../#..#/..../...#
                |#.#/.../#.# => .###/#.../.##./....
                |###/.../#.# => .#../.#../.#../#...
                |###/#../#.# => ..../##.#/##../##..
                |#.#/.#./#.# => ..##/#.#./##../#...
                |###/.#./#.# => ##../..../#.../#..#
                |###/##./#.# => #.../.##./.###/..##
                |#.#/#.#/#.# => #.../..##/#.#./##.#
                |###/#.#/#.# => ...#/#.##/#.##/#...
                |#.#/###/#.# => ##.#/###./#..#/..##
                |###/###/#.# => ..##/####/.##./..#.
                |###/#.#/### => #.##/..../..../#.#.
                |###/###/### => ###./..##/.#.#/....""".stripMargin
