package aoc
package y2024

import scala.collection.mutable

object Day6:
  private def parseField(str: String): (Set[Coord], Coord) =
    val field = (for
      (line, y) <- str.linesIterator.zipWithIndex
      x         <- line.indices
      if line.charAt(x) == '#'
    yield Coord(x, y)).toSet
    val guard = (for
      (line, y) <- str.linesIterator.zipWithIndex
      x         <- line.indices
      if line.charAt(x) == '^'
    yield Coord(x, y)).next
    (field, guard)

  def solve(input: String): Int =
    val (field, guard) = parseField(input)
    Iterator
      .iterate(guard -> (Direction.Down: Direction)): (guard, direction) =>
        val newGuard = guard + direction.direction
        if field(newGuard) then guard -> direction.left
        else newGuard                 -> direction
      .map(_(0))
      .takeWhile: guard =>
        guard.x >= 0 && guard.y >= 0 && guard.x <= field.map(_.x).max && guard.y <= field.map(_.y).max
      .toSet
      .size

  def solve2(input: String): Any =
    val (field, guard) = parseField(input)
    val cache          = mutable.Set.empty[(Coord, Direction)]
    Iterator
      .iterate(guard -> (Direction.Down: Direction)): (guard, direction) =>
        cache.add(guard -> direction)
        val newGuard = guard + direction.direction
        if field(newGuard) then guard -> direction.left
        else newGuard -> direction
      .takeWhile: (guard, _) =>
        guard.x >= 0 && guard.y >= 0 && guard.x <= field.map(_.x).max && guard.y <= field.map(_.y).max
      .filter: (guardPos, direction) =>
        Iterator
          .iterate(guardPos -> direction.left): (guard, direction) =>
            val newGuard = guard + direction.direction
            if field(newGuard) || newGuard == guardPos then guard -> direction.left
            else newGuard                                         -> direction
          .takeWhile: (guard, _) =>
            guard.x >= 0 && guard.y >= 0 && guard.x <= field.map(_.x).max && guard.y <= field.map(_.y).max
          .take(500)
          .exists((guard, direction) => cache(guard -> direction))
      .distinctBy(_(0))
      .size

  // 1846
  // 1849
  // 1907
  // 1911

  val sample = """....#.....
                 |.........#
                 |..........
                 |..#.......
                 |.......#..
                 |..........
                 |.#..^.....
                 |........#.
                 |#.........
                 |......#...""".stripMargin

  val input =
    """......#........#.............#.##..........................................#.......#...#........#......................#..........
      |.......................#...#................................#..#.........................................#.....#.....#............
      |.......................................#.................#..................#....#........................................#.......
      |.............#...................#.#...............................#....#....#.#.......................................#..#.......
      |...............................#........##.#..............................#..............................#..#...#..#..............
      |........................#......................................................................................#..#...............
      |............................#..........#.......#...................#.....#..................#.....................#..##...........
      |......................................................##........................#..............#........#..............#..#...#...
      |............................#.............................................##..........................................#...........
      |..........#............#....................................#...........#......................................................#..
      |....#......#.........................................#.......#...............................#..#.##..................#........#..
      |........................#.#..........##.#..........#......#.......#............................................................#..
      |..........................................................................................#.#..........................#..........
      |.............................#............#.......................#................#....................................#.........
      |...................................#.........................#.............#......#...#................................#.....#....
      |..........#..................#..#.....................#...#...#.........................................#................#........
      |....#....#...........#...#..........................................#.............#..#......#................#.....#..............
      |....................................................................................#......#....##..##....#.......................
      |...........................#......................#.........##................#............#.......................#...#..........
      |...........................#....................#............................................#........#.........................#.
      |..#......#.......#.#...........................#......#....#.#...#.............................#............#..............#......
      |.......#................#...................................#.........................#..................................#........
      |..................................................................#...........................................................#...
      |......................#....#........................................................................................#.............
      |...#..................#.......#......................................................................#.#....................#.....
      |................#....................................#.........#..#.........................#...............#.......#.............
      |.......................................#.................#..................................#...#...........#.....................
      |....#.....###..................#........#...#..............#............#...............................................#.........
      |...................#.......................................................#...................................#..................
      |....#......................................#...##.....#........#......#......#..........................................#.........
      |......................#............#...............#................#...............................#.............................
      |......................#..............................................#...........#............#.................................#.
      |#.#..............................#..#......#.............#.......#......................#...........#........#..........#.........
      |....#....#.......................................#.......................................................#........................
      |.......#............................#...........................#.........................#...............#.......................
      |.....................................#........#.....#........#.......................#...............#..........................#.
      |....#.......................................#........#......................................................#.................#...
      |............#..............#...#.......#..#.................................................................................##...#
      |...#..................#...................#....#............................................................................#.....
      |.....#....................#...............#.............................................#.....#...............................#...
      |..............................#.......................#.................#.......................................................#.
      |.........#....................#..............................................................................#.................#..
      |......#..................#.........................#.......#.....#...........#....#...................................#......#....
      |.........#...#......................#......#.................#.........................................#...................#......
      |....#....#.................................#..#..#........#............................................#.......#..................
      |....................#...........................#...#............#...........................#....................................
      |................#................#....#.......................................#....#..........#.#.#..........#....................
      |....#............................#...................................#.....................................................#.#....
      |....................................#............#......................#......................##.....................#.......#...
      |.........................#...................................#.....#................................................#.............
      |...........#.#..#............................................................................#.#..................................
      |....#......#.#..................................................#..#....#...#..#...................................#..............
      |#.........................#.#.................................................................#.#.............................#...
      |..................#...#........#.......................................................#....#..............................#...#..
      |.........#..........#.............................................................................................#...............
      |....................................................................#.......................#..#............#............#........
      |.................#.................#.............................................#..................................#.............
      |.#...................................................................................................#................#...........
      |...#....#.#.#.........#............#..............................................................................................
      |..................#...#......................................#...#.............#....#....#................#.......................
      |.....#................................##....................................................................#.....................
      |............#..................#......#....................#.....#.#.........................##............#............#.......#.
      |............................#..#.................#.............................................#..................................
      |............#...............#..........................................................#........#.................................
      |.......#.......#.......................................##..............##.........................................................
      |....................#.........#.....#..............#....#.......................................................#.................
      |...#............................................................#.............................................#...#............#..
      |....#..............................#...............................#..........................................#...................
      |............................................................................................................#....................#
      |..#.............................................................................................................#............#....
      |..........#...............#.........................................................#...........#.................................
      |...............#.....................#....................................#....................#.....#...#.....................#..
      |.#......#.........................................................................................#..#............................
      |......#..............#........#........#........#.........................................................#.......................
      |............................#...........#..#.............................................................................#........
      |..................#..............#.......................................#.........#...............#.....................#.#......
      |...........................................#.##...................................................................................
      |.......................#.............................................................................................#............
      |..........#................................#......#..............................#.................#........#......#.#.........#..
      |#.......#........................#.....#..........##......#................#......................................#..#..#......#..
      |........................##........................#....................#......................................#.................#.
      |..........................#.#........................................................................................#............
      |..........#.........#.....#......#............#..#................................................##.................#............
      |........#.....#............##...........................................#..#...............................................#.....#
      |..............#.......#......................#.....#.......................#.........#........#.................#...#....#........
      |..............#.................................#.................................................##..............................
      |................................#........#...........#........................................................#...................
      |..#.#..................#....#......#..............................#.....#....#.#.............#...............................#....
      |.....................................................................#......#.........#.......#.........................#....#..#.
      |.#..........................#.....#...........................................##..^.#..........................#....#....#....#...
      |...........................#..#................................................................#...#........#.........#...........
      |......#.................#..............#................#.........#........................#..#........#......#...................
      |.....#..................#..........#............................................................................#.#...........#...
      |..........#.........#.................................#......#....#...............#.....................#...#.....................
      |...........#.......#...........#..#...............#...#..............#...........................................#................
      |..............................................................#...................................................................
      |................#..............#.....................#.......#.....................................................#..............
      |#................#.......#.#..............................#..........................#.............................#..........#...
      |.#...#.........##..........#......................#....#.........#....................#...............................#.....#.....
      |....#......#.................#....................................#...............................................................
      |......#..........#...............................................................#....#...............#.....#.##..................
      |............................................................#..................#..#...................#.....#.....................
      |......................#.......#...#....#....................................#.............................#............#..........
      |.#.............#.....................#...............#.......#...............##.....#..................##...#.....................
      |........#........................................................###.#..........................................#.................
      |...##.#................................................................................................#..........................
      |.............##................#.............#....................#....#......................#........................#.....#....
      |..#.......#............................................#...............................................#..........................
      |.................#....#.......................................................#............#..#........................#.......#.#
      |...#..#......................#............#........#...........................................................................#..
      |....................................#.......................#.....................................#.....#..#......................
      |.#...............#......#...........#.....#........##....#.......#.....#...................................................#......
      |...................#...#............................#..##........#...........................#...........#........................
      |....................#.#.....................................................................................#......#..............
      |....#...........#....#...#...#.....................#............................................#..............#..................
      |......#.#......#................#......................................#...............#..........................................
      |.......#.#................#..............#.....................#.#......#..................#......................................
      |.....#................................#..............#.......#......##........#................................#..........#.......
      |.....................................#......#.........#...#.....#..........#..........................#...........................
      |......#.......#............................................................#..#....................#...............#.........#....
      |.........................#...........#.............#......#..#..............................................................#.....
      |.........#.......##.....#....................................#.....#..............#......#.......#..................##.........#..
      |.........................#...................#...#.....#...........................................#.................#..#.........
      |...........#..........#.......................................................................................................#..#
      |.....#................................................#...........................................................#....#..........
      |..............#.................................#.............#.........................................................#.........
      |............#.........................................................#.....#...............................................#.....
      |..................................................#.................#.............................#....#...#.........#.......#....
      |........#................#................................................................#................#....................#.
      |..................##............................###.........#.......#................#........#......#............#...............""".stripMargin
