package aoc
package y2024

import scala.collection.mutable

object Day6:
  private def parseField(str: String): (Set[Coord], Coord) =
    val field = (for
      (line, y) <- str.linesIterator.zipWithIndex
      x         <- line.indices
      if line.charAt(x) == '#'
    yield Coord(x, y)).toSet
    val guard = (for
      (line, y) <- str.linesIterator.zipWithIndex
      x         <- line.indices
      if line.charAt(x) == '^'
    yield Coord(x, y)).next
    (field, guard)

  private def path(guard: Coord, direction: Direction, field: Set[Coord]): Iterator[(Coord, Direction)] =
    Iterator
      .iterate(guard -> direction): (guard, direction) =>
        val newGuard = guard + direction.direction
        if field(newGuard) then guard -> direction.left
        else newGuard                 -> direction
      .takeWhile: (guard, _) =>
        guard.x >= 0 && guard.y >= 0 && guard.x <= field.map(_.x).max && guard.y <= field.map(_.y).max

  def solve(input: String): Int =
    val (field, guard) = parseField(input)
    path(guard, Direction.Down, field).distinctBy(_(0)).size

  def solve2(input: String): Int =
    val (field, guard) = parseField(input)
    val cache          = mutable.Set.empty[(Coord, Direction)]

    (for
      (guardPos, direction) <- path(guard, Direction.Down, field)
      _        = cache.add(guardPos -> direction)
      obstacle = guardPos + direction.direction
      if obstacle != guard && !field(obstacle) && !cache.exists((guard, _) => guard == obstacle)
      cache2 = mutable.Set.from(cache)
      if path(guardPos, direction.left, field + obstacle).exists((guard, direction) => !cache2.add(guard -> direction))
    yield obstacle).size

  val input =
    """......#........#.............#.##..........................................#.......#...#........#......................#..........
      |.......................#...#................................#..#.........................................#.....#.....#............
      |.......................................#.................#..................#....#........................................#.......
      |.............#...................#.#...............................#....#....#.#.......................................#..#.......
      |...............................#........##.#..............................#..............................#..#...#..#..............
      |........................#......................................................................................#..#...............
      |............................#..........#.......#...................#.....#..................#.....................#..##...........
      |......................................................##........................#..............#........#..............#..#...#...
      |............................#.............................................##..........................................#...........
      |..........#............#....................................#...........#......................................................#..
      |....#......#.........................................#.......#...............................#..#.##..................#........#..
      |........................#.#..........##.#..........#......#.......#............................................................#..
      |..........................................................................................#.#..........................#..........
      |.............................#............#.......................#................#....................................#.........
      |...................................#.........................#.............#......#...#................................#.....#....
      |..........#..................#..#.....................#...#...#.........................................#................#........
      |....#....#...........#...#..........................................#.............#..#......#................#.....#..............
      |....................................................................................#......#....##..##....#.......................
      |...........................#......................#.........##................#............#.......................#...#..........
      |...........................#....................#............................................#........#.........................#.
      |..#......#.......#.#...........................#......#....#.#...#.............................#............#..............#......
      |.......#................#...................................#.........................#..................................#........
      |..................................................................#...........................................................#...
      |......................#....#........................................................................................#.............
      |...#..................#.......#......................................................................#.#....................#.....
      |................#....................................#.........#..#.........................#...............#.......#.............
      |.......................................#.................#..................................#...#...........#.....................
      |....#.....###..................#........#...#..............#............#...............................................#.........
      |...................#.......................................................#...................................#..................
      |....#......................................#...##.....#........#......#......#..........................................#.........
      |......................#............#...............#................#...............................#.............................
      |......................#..............................................#...........#............#.................................#.
      |#.#..............................#..#......#.............#.......#......................#...........#........#..........#.........
      |....#....#.......................................#.......................................................#........................
      |.......#............................#...........................#.........................#...............#.......................
      |.....................................#........#.....#........#.......................#...............#..........................#.
      |....#.......................................#........#......................................................#.................#...
      |............#..............#...#.......#..#.................................................................................##...#
      |...#..................#...................#....#............................................................................#.....
      |.....#....................#...............#.............................................#.....#...............................#...
      |..............................#.......................#.................#.......................................................#.
      |.........#....................#..............................................................................#.................#..
      |......#..................#.........................#.......#.....#...........#....#...................................#......#....
      |.........#...#......................#......#.................#.........................................#...................#......
      |....#....#.................................#..#..#........#............................................#.......#..................
      |....................#...........................#...#............#...........................#....................................
      |................#................#....#.......................................#....#..........#.#.#..........#....................
      |....#............................#...................................#.....................................................#.#....
      |....................................#............#......................#......................##.....................#.......#...
      |.........................#...................................#.....#................................................#.............
      |...........#.#..#............................................................................#.#..................................
      |....#......#.#..................................................#..#....#...#..#...................................#..............
      |#.........................#.#.................................................................#.#.............................#...
      |..................#...#........#.......................................................#....#..............................#...#..
      |.........#..........#.............................................................................................#...............
      |....................................................................#.......................#..#............#............#........
      |.................#.................#.............................................#..................................#.............
      |.#...................................................................................................#................#...........
      |...#....#.#.#.........#............#..............................................................................................
      |..................#...#......................................#...#.............#....#....#................#.......................
      |.....#................................##....................................................................#.....................
      |............#..................#......#....................#.....#.#.........................##............#............#.......#.
      |............................#..#.................#.............................................#..................................
      |............#...............#..........................................................#........#.................................
      |.......#.......#.......................................##..............##.........................................................
      |....................#.........#.....#..............#....#.......................................................#.................
      |...#............................................................#.............................................#...#............#..
      |....#..............................#...............................#..........................................#...................
      |............................................................................................................#....................#
      |..#.............................................................................................................#............#....
      |..........#...............#.........................................................#...........#.................................
      |...............#.....................#....................................#....................#.....#...#.....................#..
      |.#......#.........................................................................................#..#............................
      |......#..............#........#........#........#.........................................................#.......................
      |............................#...........#..#.............................................................................#........
      |..................#..............#.......................................#.........#...............#.....................#.#......
      |...........................................#.##...................................................................................
      |.......................#.............................................................................................#............
      |..........#................................#......#..............................#.................#........#......#.#.........#..
      |#.......#........................#.....#..........##......#................#......................................#..#..#......#..
      |........................##........................#....................#......................................#.................#.
      |..........................#.#........................................................................................#............
      |..........#.........#.....#......#............#..#................................................##.................#............
      |........#.....#............##...........................................#..#...............................................#.....#
      |..............#.......#......................#.....#.......................#.........#........#.................#...#....#........
      |..............#.................................#.................................................##..............................
      |................................#........#...........#........................................................#...................
      |..#.#..................#....#......#..............................#.....#....#.#.............#...............................#....
      |.....................................................................#......#.........#.......#.........................#....#..#.
      |.#..........................#.....#...........................................##..^.#..........................#....#....#....#...
      |...........................#..#................................................................#...#........#.........#...........
      |......#.................#..............#................#.........#........................#..#........#......#...................
      |.....#..................#..........#............................................................................#.#...........#...
      |..........#.........#.................................#......#....#...............#.....................#...#.....................
      |...........#.......#...........#..#...............#...#..............#...........................................#................
      |..............................................................#...................................................................
      |................#..............#.....................#.......#.....................................................#..............
      |#................#.......#.#..............................#..........................#.............................#..........#...
      |.#...#.........##..........#......................#....#.........#....................#...............................#.....#.....
      |....#......#.................#....................................#...............................................................
      |......#..........#...............................................................#....#...............#.....#.##..................
      |............................................................#..................#..#...................#.....#.....................
      |......................#.......#...#....#....................................#.............................#............#..........
      |.#.............#.....................#...............#.......#...............##.....#..................##...#.....................
      |........#........................................................###.#..........................................#.................
      |...##.#................................................................................................#..........................
      |.............##................#.............#....................#....#......................#........................#.....#....
      |..#.......#............................................#...............................................#..........................
      |.................#....#.......................................................#............#..#........................#.......#.#
      |...#..#......................#............#........#...........................................................................#..
      |....................................#.......................#.....................................#.....#..#......................
      |.#...............#......#...........#.....#........##....#.......#.....#...................................................#......
      |...................#...#............................#..##........#...........................#...........#........................
      |....................#.#.....................................................................................#......#..............
      |....#...........#....#...#...#.....................#............................................#..............#..................
      |......#.#......#................#......................................#...............#..........................................
      |.......#.#................#..............#.....................#.#......#..................#......................................
      |.....#................................#..............#.......#......##........#................................#..........#.......
      |.....................................#......#.........#...#.....#..........#..........................#...........................
      |......#.......#............................................................#..#....................#...............#.........#....
      |.........................#...........#.............#......#..#..............................................................#.....
      |.........#.......##.....#....................................#.....#..............#......#.......#..................##.........#..
      |.........................#...................#...#.....#...........................................#.................#..#.........
      |...........#..........#.......................................................................................................#..#
      |.....#................................................#...........................................................#....#..........
      |..............#.................................#.............#.........................................................#.........
      |............#.........................................................#.....#...............................................#.....
      |..................................................#.................#.............................#....#...#.........#.......#....
      |........#................#................................................................#................#....................#.
      |..................##............................###.........#.......#................#........#......#............#...............""".stripMargin
